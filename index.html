<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schedule Assistant</title>
    
    <!-- iOS Home Screen Icon Settings -->
    <link rel="apple-touch-icon" href="1768891280636.jpg">
    <link rel="icon" type="image/jpeg" href="1768891280636.jpg">
    <meta name="apple-mobile-web-app-title" content="Schedule">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD Global) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat Library (Global) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Custom Scrollbar Styles -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(200, 200, 200, 0.5);
            border-radius: 20px;
        }
        body {
            background-color: #FDFBF7;
            /* Background Image Setting */
            background-image: url('ä¸‹è¼‰.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-dark {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        #root-overlay {
            background: linear-gradient(to bottom, rgba(253, 251, 247, 0.85), rgba(253, 251, 247, 0.7));
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Icons Components (SVG) ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const ChevronLeft = (props) => <IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>;
        const ChevronRight = (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>;
        const ChevronDown = (props) => <IconWrapper {...props}><path d="m6 9 6 6 6-6"/></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const CalendarIcon = (props) => <IconWrapper {...props}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></IconWrapper>;
        const User = (props) => <IconWrapper {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;
        const Users = (props) => <IconWrapper {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const Heart = (props) => <IconWrapper {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconWrapper>;
        const Check = (props) => <IconWrapper {...props}><path d="M20 6 9 17l-5-5"/></IconWrapper>;
        const CalendarRange = (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4"/><path d="M3 10h18"/><path d="M8 2v4"/><path d="M17 14h-6"/><path d="M13 18H7"/><path d="M7 14h.01"/><path d="M17 18h.01"/></IconWrapper>;
        const Edit2 = (props) => <IconWrapper {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAm1uVnuDFYgwhbV6glzMTholH8bprx1UQ",
            authDomain: "ftvphone.firebaseapp.com",
            projectId: "ftvphone",
            storageBucket: "ftvphone.firebasestorage.app",
            messagingSenderId: "786164045340",
            appId: "1:786164045340:web:f570728c9929a845a5b1d9"
        };

        // Initialize Firebase (Compat)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const appId = 'schedule-assistant-standalone';

        // --- Constants & Config ---

        const DAYS_OF_WEEK = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        const PEOPLE = {
            YANLING: { 
                id: 'yanling', 
                name: 'å¦ä¼¶', 
                colorClass: 'bg-rose-100/90 text-rose-900 border-rose-200', 
                dotColor: 'bg-rose-500',
                ringColor: 'ring-rose-200'
            },
            WEILUN: { 
                id: 'weilun', 
                name: 'è‘³å€«', 
                colorClass: 'bg-cyan-100/90 text-cyan-900 border-cyan-200', 
                dotColor: 'bg-cyan-500',
                ringColor: 'ring-cyan-200'
            },
            JOINT: {
                id: 'joint',
                name: 'å…±åŒ',
                colorClass: 'bg-orange-100/90 text-orange-900 border-orange-200',
                dotColor: 'bg-orange-500',
                ringColor: 'ring-orange-200'
            }
        };

        const DEFAULT_PRESETS = ['ä¼‘', 'å¤œ', 'æ’­'];
        const SPECIAL_DISPLAY_TITLES = ['ä¼‘', 'å¤œ', 'æ’­'];

        const CUSTOM_COLORS = [
            { bg: 'bg-red-200', text: 'text-red-900', border: 'border-red-300' },
            { bg: 'bg-orange-200', text: 'text-orange-900', border: 'border-orange-300' },
            { bg: 'bg-amber-200', text: 'text-amber-900', border: 'border-amber-300' },
            { bg: 'bg-yellow-200', text: 'text-yellow-900', border: 'border-yellow-300' },
            { bg: 'bg-lime-200', text: 'text-lime-900', border: 'border-lime-300' },
            { bg: 'bg-emerald-200', text: 'text-emerald-900', border: 'border-emerald-300' },
            { bg: 'bg-teal-200', text: 'text-teal-900', border: 'border-teal-300' },
            { bg: 'bg-sky-200', text: 'text-sky-900', border: 'border-sky-300' },
            { bg: 'bg-blue-200', text: 'text-blue-900', border: 'border-blue-300' },
            { bg: 'bg-violet-200', text: 'text-violet-900', border: 'border-violet-300' },
            { bg: 'bg-pink-200', text: 'text-pink-900', border: 'border-pink-300' },
            { bg: 'bg-gray-700', text: 'text-white', border: 'border-gray-500' },
        ];

        // --- Helper Functions ---

        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const generateCalendarDays = (year, month) => {
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const days = [];

            for (let i = 0; i < firstDay; i++) {
                days.push({ day: null, key: `pad-${i}` });
            }

            for (let i = 1; i <= daysInMonth; i++) {
                days.push({ day: i, key: `day-${i}`, dateString: `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}` });
            }

            return days;
        };

        // --- Components ---

        // æ–°å¢çš„è©³ç´°å…§å®¹ Modal
        const EventDetailModal = ({ isOpen, onClose, event, onEdit, onDelete }) => {
            if (!isOpen || !event) return null;

            const person = Object.values(PEOPLE).find(p => p.id === event.person) || PEOPLE.YANLING;
            
            // è¨ˆç®—æ¨£å¼ï¼Œå¦‚æœæœ‰è‡ªè¨‚é¡è‰²å°±ç”¨è‡ªè¨‚çš„ï¼Œå¦å‰‡ç”¨äººå“¡é è¨­
            const cardStyle = event.customColor 
                ? `${event.customColor.bg} ${event.customColor.text} border ${event.customColor.border}`
                : `${person.colorClass} border border-transparent`;

            const iconBg = event.customColor ? 'bg-white/30' : 'bg-white/50';

            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div 
                        className="bg-white/95 backdrop-blur-md rounded-[2rem] shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 border border-white/50 relative"
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header Image/Color Area */}
                        <div className={`h-32 w-full ${cardStyle} relative transition-colors duration-300`}>
                            <button 
                                onClick={onClose} 
                                className="absolute top-4 right-4 bg-black/10 hover:bg-black/20 text-current p-2 rounded-full backdrop-blur-sm transition-all"
                            >
                                <X size={20} />
                            </button>
                            <div className="absolute -bottom-10 left-6">
                                <div className={`w-20 h-20 rounded-2xl shadow-lg flex items-center justify-center text-3xl bg-white border-4 border-white`}>
                                    {event.person === 'joint' ? 'ğŸ‘¥' : (event.person === 'yanling' ? 'ğŸ‘©ğŸ»' : 'ğŸ§‘ğŸ»')}
                                </div>
                            </div>
                        </div>

                        <div className="pt-12 px-6 pb-6">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800 tracking-tight">{event.title}</h2>
                                    <div className="flex items-center gap-2 mt-1 text-gray-500 font-medium">
                                        <CalendarIcon size={14} />
                                        <span>{event.date}</span>
                                    </div>
                                </div>
                                {event.time && (
                                    <div className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-lg font-mono font-bold border border-indigo-100 flex items-center gap-1">
                                        <Clock size={14} />
                                        {event.time}
                                    </div>
                                )}
                            </div>

                            <div className="mt-4 flex items-center gap-2">
                                <span className={`px-2.5 py-0.5 rounded-md text-xs font-bold ${person.colorClass.split(' ')[0]} ${person.colorClass.split(' ')[1]}`}>
                                    {person.name}
                                </span>
                                {event.customColor && (
                                    <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">è‡ªè¨‚é¡è‰²</span>
                                )}
                            </div>

                            <div className="mt-8 grid grid-cols-2 gap-3">
                                <button 
                                    onClick={() => onEdit(event)}
                                    className="flex items-center justify-center gap-2 py-3 rounded-xl bg-gray-900 text-white font-bold hover:bg-black transition-all active:scale-95 shadow-lg"
                                >
                                    <Edit2 size={18} />
                                    ç·¨è¼¯
                                </button>
                                <button 
                                    onClick={() => { onDelete(event.id); onClose(); }}
                                    className="flex items-center justify-center gap-2 py-3 rounded-xl bg-red-50 text-red-600 font-bold hover:bg-red-100 transition-all active:scale-95"
                                >
                                    <Trash2 size={18} />
                                    åˆªé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EventFormContent = ({ 
            person, setPerson, 
            title, setTitle, 
            time, setTime,
            customColor, setCustomColor, 
            presets, 
            isAddingPreset, setIsAddingPreset, 
            newPresetText, setNewPresetText, handleAddPreset 
        }) => {
            return (
                <div className="space-y-6">
                <div className="space-y-3">
                    <label className="text-sm font-medium text-gray-500 block">é¸æ“‡äººå“¡</label>
                    <div className="grid grid-cols-3 gap-3">
                    {Object.values(PEOPLE).map((p) => (
                        <button
                        key={p.id}
                        type="button"
                        onClick={() => setPerson(p.id)}
                        className={`
                            relative overflow-hidden p-3 rounded-2xl border transition-all duration-200 flex flex-col items-center justify-center gap-1
                            ${person === p.id 
                            ? `${p.colorClass} border-transparent shadow-md scale-[1.02] ring-2 ring-offset-1 ring-gray-100` 
                            : 'bg-gray-50 border-gray-100 text-gray-400 hover:bg-gray-100'}
                        `}
                        >
                        {p.id === 'joint' ? <Users size={18} /> : <User size={18} />}
                        <span className="font-bold text-sm">{p.name}</span>
                        {person === p.id && (
                            <div className="absolute top-0 right-0 w-4 h-4 bg-current opacity-20 rounded-bl-xl" />
                        )}
                        </button>
                    ))}
                    </div>
                </div>

                <div className="space-y-3">
                    <label className="text-sm font-medium text-gray-500 block">è¡Œç¨‹å…§å®¹ & æ™‚é–“</label>
                    
                    <div className="flex flex-wrap gap-2 mb-3 items-center">
                    {presets.map((preset) => (
                        <button
                        key={preset}
                        type="button"
                        onClick={() => setTitle(preset)}
                        className={`
                            px-4 py-1.5 rounded-full text-sm font-medium transition-all
                            ${title === preset 
                            ? 'bg-gray-800 text-white shadow-md' 
                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}
                        `}
                        >
                        {preset}
                        </button>
                    ))}
                    
                    {isAddingPreset ? (
                        <div className="flex items-center gap-1 bg-white border border-indigo-200 rounded-full pl-3 pr-1 py-1 shadow-sm animate-in slide-in-from-left-2 duration-200">
                        <input 
                            type="text" 
                            autoFocus
                            value={newPresetText}
                            onChange={(e) => setNewPresetText(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddPreset())}
                            placeholder="æ–°é¡åˆ¥..."
                            className="w-20 text-sm outline-none bg-transparent"
                        />
                        <button 
                            type="button" 
                            onClick={handleAddPreset}
                            className="p-1 bg-indigo-100 text-indigo-600 rounded-full hover:bg-indigo-200"
                        >
                            <Check size={14} />
                        </button>
                        <button 
                            type="button" 
                            onClick={() => setIsAddingPreset(false)}
                            className="p-1 text-gray-400 hover:text-gray-600"
                        >
                            <X size={14} />
                        </button>
                        </div>
                    ) : (
                        <button
                        type="button"
                        onClick={() => setIsAddingPreset(true)}
                        className="px-3 py-1.5 rounded-full text-sm font-medium bg-white border border-dashed border-gray-300 text-gray-400 hover:text-indigo-600 hover:border-indigo-300 hover:bg-indigo-50 transition-all flex items-center gap-1"
                        >
                        <Plus size={14} /> 
                        </button>
                    )}
                    </div>

                    <div className="flex gap-3">
                    <input
                        type="text"
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        placeholder="è¡Œç¨‹åç¨±..."
                        className="flex-1 px-4 py-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-200 focus:bg-white transition-all outline-none text-gray-700"
                        required
                    />
                    <div className="relative">
                        <input
                        type="time"
                        value={time}
                        onChange={(e) => setTime(e.target.value)}
                        className="px-3 py-3 bg-gray-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-200 focus:bg-white transition-all outline-none text-gray-700 w-32 cursor-pointer"
                        />
                        <Clock size={16} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none" />
                    </div>
                    </div>
                </div>

                <div className="space-y-3">
                    <div className="flex justify-between items-center">
                    <label className="text-sm font-medium text-gray-500">è‡ªè¨‚é¡è‰² (12è‰²å¯é¸)</label>
                    {customColor && (
                        <button type="button" onClick={() => setCustomColor(null)} className="text-xs text-gray-400 hover:text-red-500 underline">é‡ç½®ç‚ºäººå“¡é è¨­</button>
                    )}
                    </div>
                    <div className="flex flex-wrap gap-3">
                    {CUSTOM_COLORS.map((c, idx) => (
                        <button
                        key={idx}
                        type="button"
                        onClick={() => setCustomColor(c)}
                        className={`
                            w-8 h-8 rounded-full border-2 transition-all transform
                            ${c.bg} ${customColor === c ? 'border-gray-800 scale-110 shadow-sm' : 'border-transparent hover:scale-110'}
                        `}
                        />
                    ))}
                    </div>
                </div>
                </div>
            );
        };

        const EventModal = ({ isOpen, onClose, date, onSave, editingEvent, onDelete, presets, onAddPreset }) => {
            const [person, setPerson] = useState(PEOPLE.YANLING.id);
            const [title, setTitle] = useState('');
            const [time, setTime] = useState('');
            const [customColor, setCustomColor] = useState(null);
            const [isAddingPreset, setIsAddingPreset] = useState(false);
            const [newPresetText, setNewPresetText] = useState('');

            useEffect(() => {
                if (isOpen) {
                if (editingEvent) {
                    setPerson(editingEvent.person);
                    setTitle(editingEvent.title);
                    setTime(editingEvent.time || '');
                    setCustomColor(editingEvent.customColor || null);
                } else {
                    setPerson(PEOPLE.YANLING.id);
                    setTitle('ä¼‘');
                    setTime('');
                    setCustomColor(null);
                }
                setIsAddingPreset(false);
                setNewPresetText('');
                }
            }, [isOpen, editingEvent]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                id: editingEvent ? editingEvent.id : null,
                date,
                person,
                title,
                time,
                customColor,
                });
                onClose();
            };

            const handleAddPreset = () => {
                if (newPresetText.trim()) {
                onAddPreset(newPresetText.trim());
                setTitle(newPresetText.trim());
                setNewPresetText('');
                setIsAddingPreset(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                <div className="bg-white/95 backdrop-blur-md rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 border border-white/50">
                    <div className="bg-gradient-to-r from-indigo-50/50 to-pink-50/50 p-6 flex justify-between items-center border-b border-gray-100/50">
                    <div>
                        <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        {editingEvent ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'}
                        <span className="text-sm font-normal text-gray-500 bg-white/60 px-2 py-0.5 rounded-full">
                            {date}
                        </span>
                        </h3>
                    </div>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-white/50">
                        <X size={24} />
                    </button>
                    </div>

                    <form onSubmit={handleSubmit} className="p-6">
                    <EventFormContent 
                        person={person} setPerson={setPerson}
                        title={title} setTitle={setTitle}
                        time={time} setTime={setTime}
                        customColor={customColor} setCustomColor={setCustomColor}
                        presets={presets}
                        isAddingPreset={isAddingPreset} setIsAddingPreset={setIsAddingPreset}
                        newPresetText={newPresetText} setNewPresetText={setNewPresetText}
                        handleAddPreset={handleAddPreset}
                    />

                    <div className="pt-8 flex gap-3">
                        {/* åˆªé™¤æŒ‰éˆ•ç§»åˆ°è©³ç´°é é¢ï¼Œé€™è£¡åªç•™å„²å­˜ï¼Œé™¤éæ˜¯æ–°å¢æ¨¡å¼ */}
                        {editingEvent && (
                           <div/>
                        )}
                        <button
                        type="submit"
                        className="flex-1 bg-gray-900 text-white py-3 rounded-xl font-bold text-lg hover:bg-black transition-colors shadow-lg active:scale-95 transform duration-100"
                        >
                        {editingEvent ? 'æ›´æ–°è¡Œç¨‹' : 'åŠ å…¥è¡Œç¨‹'}
                        </button>
                    </div>
                    </form>
                </div>
                </div>
            );
        };

        const BatchAddModal = ({ isOpen, onClose, year, month, onSaveBatch, presets, onAddPreset }) => {
            const [person, setPerson] = useState(PEOPLE.YANLING.id);
            const [title, setTitle] = useState('ä¼‘');
            const [time, setTime] = useState('');
            const [customColor, setCustomColor] = useState(null);
            const [selectedDates, setSelectedDates] = useState([]);
            
            const [isAddingPreset, setIsAddingPreset] = useState(false);
            const [newPresetText, setNewPresetText] = useState('');

            const days = generateCalendarDays(year, month);

            useEffect(() => {
                if (isOpen) {
                setSelectedDates([]);
                }
            }, [isOpen]);

            if (!isOpen) return null;

            const toggleDate = (dateString) => {
                if (selectedDates.includes(dateString)) {
                setSelectedDates(selectedDates.filter(d => d !== dateString));
                } else {
                setSelectedDates([...selectedDates, dateString]);
                }
            };

            const handleSave = () => {
                if (selectedDates.length === 0) return;
                onSaveBatch({
                dates: selectedDates,
                person,
                title,
                time,
                customColor
                });
                onClose();
            };

            const handleAddPreset = () => {
                if (newPresetText.trim()) {
                onAddPreset(newPresetText.trim());
                setTitle(newPresetText.trim());
                setNewPresetText('');
                setIsAddingPreset(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                <div className="bg-white/95 backdrop-blur-md rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 border border-white/50 flex flex-col max-h-[90vh]">
                    
                    <div className="bg-gradient-to-r from-indigo-50/50 to-pink-50/50 p-6 flex justify-between items-center border-b border-gray-100/50 shrink-0">
                    <div>
                        <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        å¿«é€Ÿæ’ç­
                        <span className="text-sm font-normal text-indigo-600 bg-indigo-50/80 px-2 py-0.5 rounded-full border border-indigo-100">
                            å·²é¸ {selectedDates.length} å¤©
                        </span>
                        </h3>
                        <p className="text-xs text-gray-500 mt-1">è¨­å®šä¸€å€‹è¡Œç¨‹ï¼Œå¥—ç”¨åˆ°å¤šå€‹æ—¥æœŸ</p>
                    </div>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-white/50">
                        <X size={24} />
                    </button>
                    </div>

                    <div className="overflow-y-auto p-6">
                    <EventFormContent 
                        person={person} setPerson={setPerson}
                        title={title} setTitle={setTitle}
                        time={time} setTime={setTime}
                        customColor={customColor} setCustomColor={setCustomColor}
                        presets={presets}
                        isAddingPreset={isAddingPreset} setIsAddingPreset={setIsAddingPreset}
                        newPresetText={newPresetText} setNewPresetText={setNewPresetText}
                        handleAddPreset={handleAddPreset}
                    />

                    <div className="mt-8 space-y-3">
                        <label className="text-sm font-medium text-gray-500 block">é»æ“Šæ—¥æœŸä»¥é¸å– (ç•¶æœˆ)</label>
                        <div className="grid grid-cols-7 gap-1.5 bg-gray-50/50 p-4 rounded-2xl border border-gray-100">
                            {DAYS_OF_WEEK.map(d => (
                            <div key={d} className="text-center text-xs text-gray-400 font-medium mb-1">{d}</div>
                            ))}
                            {days.map((item) => {
                            if (!item.day) return <div key={item.key} />;
                            const isSelected = selectedDates.includes(item.dateString);
                            return (
                                <button
                                key={item.key}
                                type="button"
                                onClick={() => toggleDate(item.dateString)}
                                className={`
                                    aspect-square rounded-xl flex items-center justify-center text-sm font-semibold transition-all duration-200
                                    ${isSelected 
                                    ? 'bg-indigo-600 text-white shadow-md scale-95' 
                                    : 'bg-white text-gray-600 hover:bg-indigo-50 border border-gray-100 hover:border-indigo-200'}
                                `}
                                >
                                {item.day}
                                </button>
                            );
                            })}
                        </div>
                    </div>
                    </div>

                    <div className="p-6 pt-0 shrink-0">
                    <button
                        onClick={handleSave}
                        disabled={selectedDates.length === 0}
                        className={`
                        w-full py-3 rounded-xl font-bold text-lg transition-colors shadow-lg transform duration-100
                        ${selectedDates.length === 0 
                            ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                            : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'}
                        `}
                    >
                        {selectedDates.length === 0 ? 'è«‹é¸æ“‡æ—¥æœŸ' : `åŠ å…¥ ${selectedDates.length} å€‹è¡Œç¨‹`}
                    </button>
                    </div>

                </div>
                </div>
            );
        };

        function App() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [events, setEvents] = useState([]);
            const [presets, setPresets] = useState(DEFAULT_PRESETS);
            const [user, setUser] = useState(null);
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isDetailModalOpen, setIsDetailModalOpen] = useState(false); // New state for detail modal
            const [isBatchModalOpen, setIsBatchModalOpen] = useState(false);
            
            const [selectedDate, setSelectedDate] = useState(null);
            const [editingEvent, setEditingEvent] = useState(null);

            const [isMonthPickerOpen, setIsMonthPickerOpen] = useState(false);
            const [pickerYear, setPickerYear] = useState(currentDate.getFullYear());

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (err) {
                        console.error("Anonymous auth failed:", err);
                    }
                };

                initAuth();
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;

                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('events')
                    .onSnapshot((snapshot) => {
                        const loadedEvents = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setEvents(loadedEvents);
                    }, (error) => {
                        console.error("Error loading events:", error);
                    });

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) return;

                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('presets')
                    .onSnapshot((snapshot) => {
                        const customPresets = snapshot.docs.map(doc => doc.data().name);
                        const uniquePresets = Array.from(new Set([...DEFAULT_PRESETS, ...customPresets]));
                        setPresets(uniquePresets);
                    }, (error) => {
                        console.error("Error loading presets:", error);
                    });

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (isMonthPickerOpen) {
                    setPickerYear(currentDate.getFullYear());
                }
            }, [isMonthPickerOpen, currentDate]);


            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const days = generateCalendarDays(year, month);

            const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
            const today = () => setCurrentDate(new Date());

            const handleDateClick = (dateString) => {
                setSelectedDate(dateString);
                setEditingEvent(null);
                setIsModalOpen(true);
            };

            const handleEventClick = (e, event) => {
                e.stopPropagation();
                setEditingEvent(event);
                setIsDetailModalOpen(true); // Open detail modal instead of edit modal
            };

            const handleEditFromDetail = (event) => {
                setIsDetailModalOpen(false);
                setSelectedDate(event.date);
                setEditingEvent(event);
                setIsModalOpen(true);
            };

            const saveEvent = async (eventData) => {
                if (!user) return;
                try {
                    const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('events');
                    if (eventData.id) {
                        const { id, ...dataToSave } = eventData;
                        await collectionRef.doc(id).update(dataToSave);
                    } else {
                        const { id, ...dataToSave } = eventData;
                        await collectionRef.add(dataToSave);
                    }
                } catch (err) {
                    console.error("Error saving event:", err);
                }
            };

            const saveBatchEvents = async (batchData) => {
                if (!user) return;
                try {
                    const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('events');
                    const batch = db.batch();
                    
                    batchData.dates.forEach(date => {
                        const docRef = collectionRef.doc();
                        batch.set(docRef, {
                            date,
                            person: batchData.person,
                            title: batchData.title,
                            time: batchData.time,
                            customColor: batchData.customColor
                        });
                    });
                    
                    await batch.commit();
                } catch (err) {
                    console.error("Error batch saving:", err);
                }
            };

            const deleteEvent = async (id) => {
                if (!user) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('events').doc(id).delete();
                } catch (err) {
                    console.error("Error deleting event:", err);
                }
            };

            const addPreset = async (newPreset) => {
                if (!user) return;
                if (presets.includes(newPreset)) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('presets').add({
                        name: newPreset
                    });
                } catch (err) {
                    console.error("Error adding preset:", err);
                }
            };

            const getEventStyle = (event) => {
                if (event.customColor) {
                return `${event.customColor.bg} ${event.customColor.text} border ${event.customColor.border}`;
                }
                const person = Object.values(PEOPLE).find(p => p.id === event.person);
                return person ? `${person.colorClass} border border-transparent` : 'bg-gray-100 text-gray-800';
            };

            const getPersonName = (id) => {
                return Object.values(PEOPLE).find(p => p.id === id)?.name || '';
            };

            return (
                <div id="root-overlay">
                
                {/* Decorative Background Elements - kept but blurred for depth */}
                <div className="fixed top-0 left-0 w-64 h-64 bg-rose-200 rounded-full blur-[100px] opacity-20 -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
                <div className="fixed bottom-0 right-0 w-96 h-96 bg-cyan-200 rounded-full blur-[100px] opacity-20 translate-x-1/3 translate-y-1/3 pointer-events-none"></div>

                {isMonthPickerOpen && (
                    <div className="fixed inset-0 z-40 bg-transparent" onClick={() => setIsMonthPickerOpen(false)} />
                )}

                <div className="max-w-6xl mx-auto p-2 md:p-8 relative z-10">
                    
                    <header className="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6">
                    <div className="text-center lg:text-left">
                        <h1 className="text-2xl md:text-3xl font-extrabold tracking-tight flex items-center gap-2 justify-center lg:justify-start">
                        <span className="bg-gradient-to-r from-rose-500 to-cyan-500 bg-clip-text text-transparent drop-shadow-sm">Schedule</span> 
                        <CalendarIcon className="w-6 h-6 text-cyan-600" />
                        </h1>
                        <p className="text-gray-500 text-sm font-medium mt-1">è¡Œç¨‹ç®¡ç†å°å¹«æ‰‹</p>
                    </div>

                    <div className="flex flex-col sm:flex-row items-center gap-4">
                        <div className="flex items-center gap-2 glass p-2 rounded-2xl shadow-sm relative">
                        <button onClick={prevMonth} className="p-2 hover:bg-white/50 rounded-xl transition-colors text-gray-700">
                            <ChevronLeft size={20} />
                        </button>
                        
                        <div className="relative">
                            <div 
                                className="w-44 text-center cursor-pointer hover:bg-white/50 rounded-xl transition-all py-1 px-2 border border-transparent hover:border-white/50 flex items-center justify-center gap-2" 
                                onClick={() => setIsMonthPickerOpen(!isMonthPickerOpen)}
                            >
                                <span className="text-xl font-bold tabular-nums text-gray-800">
                                {year} å¹´ {month + 1} æœˆ
                                </span>
                                <ChevronDown size={14} className={`text-gray-500 transition-transform duration-200 ${isMonthPickerOpen ? 'rotate-180' : ''}`} />
                            </div>
                            
                            {isMonthPickerOpen && (
                                <div className="absolute top-full mt-2 left-1/2 -translate-x-1/2 w-64 glass-dark rounded-2xl shadow-xl border border-white/50 z-50 p-4 animate-in fade-in zoom-in-95 duration-200">
                                    <div className="flex justify-between items-center mb-4">
                                        <button onClick={() => setPickerYear(pickerYear - 1)} className="p-1 hover:bg-gray-100 rounded-lg">
                                            <ChevronLeft size={20} className="text-gray-500" />
                                        </button>
                                        <span className="font-bold text-lg text-gray-800 tabular-nums">{pickerYear}</span>
                                        <button onClick={() => setPickerYear(pickerYear + 1)} className="p-1 hover:bg-gray-100 rounded-lg">
                                            <ChevronRight size={20} className="text-gray-500" />
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-2">
                                        {Array.from({ length: 12 }, (_, i) => (
                                            <button
                                                key={i}
                                                onClick={() => {
                                                    setCurrentDate(new Date(pickerYear, i, 1));
                                                    setIsMonthPickerOpen(false);
                                                }}
                                                className={`
                                                    py-2 rounded-lg text-sm font-medium transition-colors
                                                    ${pickerYear === year && i === month 
                                                        ? 'bg-indigo-600 text-white shadow-md' 
                                                        : 'text-gray-600 hover:bg-gray-100'}
                                                `}
                                            >
                                                {i + 1} æœˆ
                                            </button>
                                        ))}
                                    </div>
                                    
                                    <button 
                                        onClick={() => {
                                            setCurrentDate(new Date());
                                            setIsMonthPickerOpen(false);
                                        }}
                                        className="w-full mt-3 py-2 text-sm text-indigo-600 font-medium hover:bg-indigo-50 rounded-lg transition-colors border-t border-gray-100 mt-4"
                                    >
                                        å›åˆ°ä»Šå¤©
                                    </button>
                                </div>
                            )}
                        </div>

                        <button onClick={nextMonth} className="p-2 hover:bg-white/50 rounded-xl transition-colors text-gray-700">
                            <ChevronRight size={20} />
                        </button>
                        </div>

                        <button 
                        onClick={() => setIsBatchModalOpen(true)}
                        className="px-4 py-3 glass hover:bg-white/80 text-indigo-700 font-bold rounded-2xl shadow-sm flex items-center gap-2 transition-all active:scale-95 border-white/60"
                        >
                        <CalendarRange size={18} />
                        å¿«é€Ÿæ’ç­
                        </button>
                    </div>

                    <div className="flex gap-2 text-sm font-medium">
                        <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-lg">
                            <div className="w-2 h-2 rounded-full bg-rose-400"></div>
                            <span className="text-rose-900">å¦ä¼¶</span>
                        </div>
                        <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-lg">
                            <div className="w-2 h-2 rounded-full bg-cyan-400"></div>
                            <span className="text-cyan-900">è‘³å€«</span>
                        </div>
                        <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-lg">
                            <div className="w-2 h-2 rounded-full bg-orange-400"></div>
                            <span className="text-orange-900">å…±åŒ</span>
                        </div>
                    </div>
                    </header>

                    <div className="glass rounded-[2rem] shadow-xl overflow-hidden">
                    
                    <div className="grid grid-cols-7 border-b border-gray-200/50 bg-white/30 backdrop-blur-sm">
                        {DAYS_OF_WEEK.map((day, idx) => (
                        <div key={day} className={`py-2 md:py-4 text-center text-xs md:text-sm font-semibold ${idx === 0 || idx === 6 ? 'text-rose-500' : 'text-gray-500'}`}>
                            {day}
                        </div>
                        ))}
                    </div>

                    <div className="grid grid-cols-7 auto-rows-[minmax(70px,1fr)] md:auto-rows-[minmax(140px,1fr)]">
                        {days.map((item, index) => {
                        if (!item.day) {
                            return <div key={item.key} className="bg-white/10 border-b border-r border-gray-200/30" />;
                        }

                        const isToday = new Date().toDateString() === new Date(year, month, item.day).toDateString();
                        const dayEvents = events
                            .filter(e => e.date === item.dateString)
                            .sort((a, b) => {
                                const priorityOrder = ['ä¼‘', 'å¤œ', 'æ’­'];
                                const priorityA = priorityOrder.indexOf(a.title);
                                const priorityB = priorityOrder.indexOf(b.title);
                                
                                if (priorityA !== -1 && priorityB !== -1) return priorityA - priorityB; 
                                if (priorityA !== -1) return -1;
                                if (priorityB !== -1) return 1;

                                if (a.time && !b.time) return -1;
                                if (!a.time && b.time) return 1;
                                if (a.time && b.time) return a.time.localeCompare(b.time);
                                
                                return 0;
                            });

                        return (
                            <div 
                            key={item.key} 
                            onClick={() => handleDateClick(item.dateString)}
                            className={`
                                group relative p-1 md:p-2 border-b border-r border-gray-200/40 transition-all duration-200 hover:bg-white/40 cursor-pointer flex flex-col gap-1
                                ${isToday ? 'bg-indigo-50/40' : 'bg-white/20'}
                            `}
                            >
                            <div className="flex justify-between items-start mb-1">
                                <span 
                                className={`
                                    w-6 h-6 md:w-7 md:h-7 flex items-center justify-center rounded-full text-xs md:text-sm font-medium
                                    ${isToday ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'text-gray-600 group-hover:bg-white/60'}
                                `}
                                >
                                {item.day}
                                </span>
                                
                                <button className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-indigo-600 transition-opacity">
                                <Plus size={16} />
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto space-y-1 custom-scrollbar">
                                {dayEvents.map(event => {
                                    const isSpecial = SPECIAL_DISPLAY_TITLES.includes(event.title);
                                    // åˆ¤æ–·æ˜¯å¦ç‚ºç‰¹æ®Šè¡Œç¨‹ï¼Œåˆ†åˆ¥çµ¦äºˆä¸åŒçš„å®¹å™¨æ¨£å¼
                                    // ç‰¹æ®Šè¡Œç¨‹ï¼šæ¢å¾©åŸæœ¬çš„ truncate èˆ‡æ¨£å¼
                                    // ä¸€èˆ¬è¡Œç¨‹ï¼šä½¿ç”¨ overflow-hidden èˆ‡å¤šè¡Œé…ç½®
                                    const containerClass = isSpecial 
                                        ? "text-[10px] md:text-sm px-1.5 py-1 md:px-2 md:py-1.5 rounded-md md:rounded-lg truncate font-medium shadow-sm transition-transform hover:scale-[1.02] active:scale-95 cursor-pointer border-l-2 md:border-l-[3px] flex flex-col justify-center backdrop-blur-[2px]"
                                        : "text-[10px] md:text-sm px-1.5 py-1 md:px-2 md:py-1.5 rounded-md md:rounded-lg font-medium shadow-sm transition-transform hover:scale-[1.02] active:scale-95 cursor-pointer border-l-2 md:border-l-[3px] flex flex-col justify-center backdrop-blur-[2px] overflow-hidden";

                                    return (
                                        <div
                                            key={event.id}
                                            onClick={(e) => handleEventClick(e, event)}
                                            className={`
                                            ${containerClass}
                                            ${getEventStyle(event)}
                                            `}
                                        >
                                            {isSpecial ? (
                                                <div className="font-bold text-[10px] md:text-xs flex items-center gap-1">
                                                    <span>{getPersonName(event.person)}</span>
                                                    <span>{event.title}</span>
                                                </div>
                                            ) : (
                                                <div className="flex flex-col w-full">
                                                    {event.time && (
                                                        <div className="text-[10px] md:text-xs font-mono font-bold leading-tight mb-0.5 border-b border-black/10 pb-0.5">
                                                            {event.time}
                                                        </div>
                                                    )}
                                                    <div className="flex flex-col w-full min-w-0">
                                                        <span className={`font-bold text-[10px] md:text-sm leading-tight text-left ${event.title.length > 4 ? 'whitespace-normal line-clamp-2 break-all' : 'truncate'}`}>{event.title}</span>
                                                        <span className="opacity-75 font-medium text-[9px] md:text-[10px] text-right mt-0.5 -mb-0.5">
                                                            {getPersonName(event.person)}
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            </div>
                        );
                        })}
                    </div>
                    </div>

                    <div className="mt-8 text-center text-gray-500 text-sm font-medium">
                    <p>Â© {new Date().getFullYear()} Schedule Assistant â€¢ Made with <Heart className="inline w-3 h-3 text-rose-500" fill="currentColor" /> for Yanling & Weilun</p>
                    </div>
                </div>

                {/* Edit / Add Modal */}
                <EventModal 
                    isOpen={isModalOpen} 
                    onClose={() => setIsModalOpen(false)} 
                    date={selectedDate}
                    onSave={saveEvent}
                    onDelete={deleteEvent}
                    editingEvent={editingEvent}
                    presets={presets}
                    onAddPreset={addPreset}
                />

                {/* Detail View Modal */}
                <EventDetailModal
                    isOpen={isDetailModalOpen}
                    onClose={() => setIsDetailModalOpen(false)}
                    event={editingEvent}
                    onEdit={handleEditFromDetail}
                    onDelete={deleteEvent}
                />

                {/* Batch Add Modal */}
                <BatchAddModal 
                    isOpen={isBatchModalOpen}
                    onClose={() => setIsBatchModalOpen(false)}
                    year={year}
                    month={month}
                    onSaveBatch={saveBatchEvents}
                    presets={presets}
                    onAddPreset={addPreset}
                />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
